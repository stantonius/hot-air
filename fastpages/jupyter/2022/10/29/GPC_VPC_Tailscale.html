<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Google Cloud VPC with Tailscale | The Coding Hobbyist</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Google Cloud VPC with Tailscale" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Covering the basics of VPC and how to access with a VPN" />
<meta property="og:description" content="Covering the basics of VPC and how to access with a VPN" />
<link rel="canonical" href="https://stantonius.github.io/home/fastpages/jupyter/2022/10/29/GPC_VPC_Tailscale.html" />
<meta property="og:url" content="https://stantonius.github.io/home/fastpages/jupyter/2022/10/29/GPC_VPC_Tailscale.html" />
<meta property="og:site_name" content="The Coding Hobbyist" />
<meta property="og:image" content="https://stantonius.github.io/home/images/some_folder/your_image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-29T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2022-10-29T00:00:00-05:00","url":"https://stantonius.github.io/home/fastpages/jupyter/2022/10/29/GPC_VPC_Tailscale.html","@type":"BlogPosting","image":"https://stantonius.github.io/home/images/some_folder/your_image.png","headline":"Google Cloud VPC with Tailscale","dateModified":"2022-10-29T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://stantonius.github.io/home/fastpages/jupyter/2022/10/29/GPC_VPC_Tailscale.html"},"description":"Covering the basics of VPC and how to access with a VPN","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/home/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://stantonius.github.io/home/feed.xml" title="The Coding Hobbyist" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZYM0GN6Q4W"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZYM0GN6Q4W');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/home/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/home/">The Coding Hobbyist</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/home/about/">About Me</a><a class="page-link" href="/home/search/">Search</a><a class="page-link" href="/home/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Google Cloud VPC with Tailscale</h1><p class="page-description">Covering the basics of VPC and how to access with a VPN</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-10-29T00:00:00-05:00" itemprop="datePublished">
        Oct 29, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/home/categories/#fastpages">fastpages</a>
        &nbsp;
      
        <a class="category-tags-link" href="/home/categories/#jupyter">jupyter</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#objective">Objective</a></li>
<li class="toc-entry toc-h2"><a href="#virtual-private-clouds">Virtual Private Clouds</a>
<ul>
<li class="toc-entry toc-h3"><a href="#why-a-custom-vpc-network">Why a Custom VPC network?</a></li>
<li class="toc-entry toc-h3"><a href="#vpcs-are-global">VPCs are Global</a></li>
<li class="toc-entry toc-h3"><a href="#vpc-subnets">VPC Subnets</a>
<ul>
<li class="toc-entry toc-h4"><a href="#vpc-subnets--regions">VPC Subnets &amp; Regions</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#vpc-access">VPC Access</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#tailscale-vpn">Tailscale VPN</a></li>
<li class="toc-entry toc-h2"><a href="#firewall">Firewall</a>
<ul>
<li class="toc-entry toc-h3"><a href="#allowing-internal-traffic-within-our-vpc">Allowing Internal Traffic within our VPC</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#assigning-private-ips-to-gcp-resources">Assigning Private IPs to GCP Resources</a></li>
<li class="toc-entry toc-h2"><a href="#background-notes">Background Notes</a></li>
</ul><h2 id="objective">
<a class="anchor" href="#objective" aria-hidden="true"><span class="octicon octicon-link"></span></a>Objective</h2>

<ol>
  <li>Set up a custom VPC network</li>
  <li>Set up a VPN so that we can access our private resources from our local development machines</li>
</ol>

<h2 id="virtual-private-clouds">
<a class="anchor" href="#virtual-private-clouds" aria-hidden="true"><span class="octicon octicon-link"></span></a>Virtual Private Clouds</h2>

<p>Out of curiosity, I decided to create a custom VPC for our project. In our case, the specific subnet we are using is in the <code class="language-plaintext highlighter-rouge">northamerica-northeast1</code> region. We created a subnet range of <code class="language-plaintext highlighter-rouge">10.1.0.0/16</code></p>

<blockquote>
  <p>Note the range of IP addresses selected for a subnet is completely arbirtrary - in my case there are way too many addresses for this subnet, but I essentially randomly chose the configuration. This is OK because there is currently no charge for static or ephemeral internal IP addresses. However the takeaway point is I could have selected any block of private IP addresses for this project.</p>
</blockquote>

<p align="center">
  <img src="https://storage.googleapis.com/craigstanton-public-assets/images/vpc/vpc.png" width="500" height="700">
</p>

<h3 id="why-a-custom-vpc-network">
<a class="anchor" href="#why-a-custom-vpc-network" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why a Custom VPC network?</h3>

<p>Upon reflection, I don’t think this was necessary. I think it would have been perfectly acceptable to use the <code class="language-plaintext highlighter-rouge">default</code> VPC network that GCP creates for every project. The reason I say this is we are not using the VPC to segment access to resources (ie. using vLANs) for security purposes. We are simply using a VPC to prevent public access to private resources. Therefore the <code class="language-plaintext highlighter-rouge">default</code> VPC would have worked fine for this.</p>

<h3 id="vpcs-are-global">
<a class="anchor" href="#vpcs-are-global" aria-hidden="true"><span class="octicon octicon-link"></span></a>VPCs are Global</h3>

<p>A single VPC is a global resource - it is not tied to any one region. However a VPC itself does not have any IP addresses that are assignable to cloud resources - the only way to add a resource to a VPC is via subnets.</p>

<h3 id="vpc-subnets">
<a class="anchor" href="#vpc-subnets" aria-hidden="true"><span class="octicon octicon-link"></span></a>VPC Subnets</h3>

<p>Subnets are just a segment of IP addresses. You use subnets to create blocks of IP addresses that are assignable to cloud resources.</p>

<h4 id="vpc-subnets--regions">
<a class="anchor" href="#vpc-subnets--regions" aria-hidden="true"><span class="octicon octicon-link"></span></a>VPC Subnets &amp; Regions</h4>

<p>Cloud resources are assigned a private IP address <em>from a specific subnet</em>. As a reminder, each subnet must be assigned to a specific GCP region.</p>

<blockquote>
  <p>Can you assign a GCP resource hosted in one region to a subnet in another region? No - the subnet that a resource is assigned <em>must</em> be a part of the same region that the resource is hosted in.</p>
</blockquote>

<p>The obvious question that arises is: can resources on 1 subnet communicate with a resource on another subnet on the same VPC? The answer all depends on the <strong>firewall rules</strong>. If using the <code class="language-plaintext highlighter-rouge">default</code> VPC, then the firewall is preconfigured to allow internal traffic between all subnets of a particular VPC. However if we have set up a custom VPC, we need to manually configure the firewall to allow this traffic - this is explained in the [[#Firewall]] section below.</p>

<h3 id="vpc-access">
<a class="anchor" href="#vpc-access" aria-hidden="true"><span class="octicon octicon-link"></span></a>VPC Access</h3>

<p>Using a VPC effectively creates a virtual “wall” around our resources. This means we have full control over access to these resources, and by default access is pretty restricted. Clearly there are many ways to access these resources depending on what we are trying to do, among them are SSH and reverse-proxy setups. However we are not going to discuss those here.</p>

<p>What I will touch on is how do we access these resources from our local development machines using a VPN. For example, say I want to query a SQL database that only has a private IP address - I need some way to allow inbound traffic to the SQL instance. Check out the [[#Tailscale VPN]] section below for more information.</p>

<h2 id="tailscale-vpn">
<a class="anchor" href="#tailscale-vpn" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tailscale VPN</h2>

<p>So if all of our machines are only accessible within the VPC, how do we access the resources on our local machines? The answer is of course via a VPN.</p>

<p>Tailscale has good resources on how to <a href="https://tailscale.com/kb/1147/cloud-gce/">connect to GCP VPC</a> and importantly how to enable the VM as a <a href="https://tailscale.com/kb/1019/subnets/">subnet router</a>, so there is no point repeating them here.</p>

<p>However there are a few concepts that I picked up that are worth outlining:</p>

<ul>
  <li>The tailscale “tunnel” is a VM that listens for UDP on port 41641 (hence the reason for modifying the firewall to enable traffic on that port)
    <ul>
      <li>While this seems obvious now, its important for me to stress that VPNs are not magic - they still require <em>some way</em> through the firewall. It is just that these enabled ports on a firewall for a VPN are a) not traditional like 22 and b) do not require and manual credential exchange authentication.</li>
      <li>Therefore if you only ever wanted to access resources on a VPC via a VPN, you would set up the firewall to block all ingress traffic <em>except for the Tailscale ports</em>
</li>
    </ul>
  </li>
  <li>The tailscale VM does have a public IP address so that we can connect to it from anywhere.
    <ul>
      <li>Note that this does not mean that this public IP address is widely used - in fact, we <strong>disable SSH</strong> <strong>and HTTP/S</strong> on this instance so that it cannot be accessed outside of the VPN</li>
      <li>We only allow UDP traffic on the specific Tailscale port</li>
    </ul>
  </li>
  <li>Our Tailscale VM is effectively a <strong>router</strong>. As such, the Tailscale instance <em>must advertise itself</em> as a router accepting traffic to <em>certain IP ranges</em>.
    <ul>
      <li>This is done via a Tailscale SDK command. For example: <code class="language-plaintext highlighter-rouge">sudo tailscale up --advertise-routes=10.0.0.0/24,10.0.1.0/24</code>
</li>
    </ul>
  </li>
</ul>

<p>So what does this mean in practice? Well in order to test our config locally, connect to a VM, etc., I must be logged in and running Tailscale on my Mac.</p>

<h2 id="firewall">
<a class="anchor" href="#firewall" aria-hidden="true"><span class="octicon octicon-link"></span></a>Firewall</h2>

<p>As alluded to above, just because we have created a VPC and assigned cloud resources to it, doesn’t mean that all traffic is automatically permitted between these resources*. We still need to check the firewall rules to ensure that traffic can flow only where we want it.</p>

<p>* <em>if you choose to build your subnets manually. I think internal traffic is allowed if you let GCP configure all 36 subnets automatically</em></p>

<p>The two rules we need to set up for our use case are a) to allow all traffic within the subnet to connect to all other machines on the subnet and b) allow Tailscale UDP traffic.</p>

<h3 id="allowing-internal-traffic-within-our-vpc">
<a class="anchor" href="#allowing-internal-traffic-within-our-vpc" aria-hidden="true"><span class="octicon octicon-link"></span></a>Allowing Internal Traffic within our VPC</h3>

<p align="center">
  <img src="https://storage.googleapis.com/craigstanton-public-assets/images/vpc/vpc_firewall.png" width="380" height="400">
</p>

<p>As you can see, the setup above allows us to communicate with any other resource on the VPC - because of the <code class="language-plaintext highlighter-rouge">/8</code> CIDR notation, this rule covers <strong>all subnets</strong> in our VPC. As mentioned, without this rule you cannot even ping another instance on the subnet - the firewall default denies all traffic that we haven’t explicitly allowed.</p>

<p>Should I have allowed all traffic to all ports from any instance with a <code class="language-plaintext highlighter-rouge">10.x</code> IP address? Well because it is an internal LAN/subnet, this is low risk.</p>

<p>The Tailscale firewall setup was equally as straightforward:</p>

<p align="center">
  <img src="https://storage.googleapis.com/craigstanton-public-assets/images/vpc/tailscale_firewall.png" width="350" height="400">
</p>

<h2 id="assigning-private-ips-to-gcp-resources">
<a class="anchor" href="#assigning-private-ips-to-gcp-resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Assigning Private IPs to GCP Resources</h2>

<p>Generally speaking, it is advisable to have the VPC set up <em>before</em> you create these resources because it is sometimes hard to add after the fact. Pay particular attention to serverless and managed CloudSQL instances - these need</p>

<h2 id="background-notes">
<a class="anchor" href="#background-notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background Notes</h2>

<ul>
  <li>A Virtual Private Cloud is just a set of private IP addresses. A VPC can have one or many subnets.
    <ul>
      <li>The VPC itself is a global resource, not bound to any region</li>
      <li>A VPC doesn’t have IP addresses on its own; private IP addresses are allocated via subnets</li>
    </ul>
  </li>
  <li>A subnet is a <em>subset</em> of internal IP addresses
    <ul>
      <li>As internal/private IP addresses, they must be within one of the IANA IPv4 private network ranges: <code class="language-plaintext highlighter-rouge">10.0.0.0/8</code>, <code class="language-plaintext highlighter-rouge">172.16.0.0/12</code>, or <code class="language-plaintext highlighter-rouge">192.168.0.0/16</code>
</li>
    </ul>
  </li>
  <li>In GCP VPCs, a subnet can only span a <strong>single GCP region</strong>. This is why GCP creates 36 subnets (as of Oct 2022) within the <code class="language-plaintext highlighter-rouge">default</code> VPC of a project  - one subnet per region</li>
  <li>Cloud resources are assigned a private IP address from one of the VPC subnets.
    <ul>
      <li>A single resource can only have 1 private IP address</li>
    </ul>
  </li>
  <li>VPC is advantageous because:
    <ol>
      <li>You do not need to expose as many/any resources to the public internet</li>
      <li>Lower latency traffic between resources</li>
    </ol>
  </li>
  <li>There are some caveats and gotchas (there are probably more - these are just the ones I have come across):
    <ul>
      <li>Special configuration is needed to assign serverless resources to a VPC (this makes sense - they’re ephemeral)</li>
      <li>SSH’ing to a VM without a Public IP but has a Private IP that is part of the VPC needs to be done via Identty Access Proxy
        <ul>
          <li>This makes <strong>automating config via Ansible more difficult</strong> (an article on how to tell Ansible to use IAP Tunneling is <a href="https://binx.io/2021/03/10/how-to-tell-ansible-to-use-gcp-iap-tunneling/">here</a>)</li>
        </ul>
      </li>
      <li>Fully-managed servers (aka CloudSQL) still need a proxy for VPC network peering
        <ul>
          <li>Discovered this when setting up DataStream, which uses its own VPC and requires peering to access any resources on another VPC</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="stantonius/home"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/home/fastpages/jupyter/2022/10/29/GPC_VPC_Tailscale.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/home/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/home/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/home/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Posts related to AI, IoT, Home Labs, Flutter, GCP, Privacy-Enhancing Tech...the list grows every week.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/stantonius" target="_blank" title="stantonius"><svg class="svg-icon grey"><use xlink:href="/home/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/thecraigman22" target="_blank" title="thecraigman22"><svg class="svg-icon grey"><use xlink:href="/home/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
